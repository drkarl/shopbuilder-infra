services:
  # Node.js frontend served by Nginx
  frontend:
    image: ${FRONTEND_IMAGE:-shopbuilder/frontend:latest}
    container_name: shopbuilder-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "${FRONTEND_CPU_LIMIT:-0.5}"
          memory: ${FRONTEND_MEMORY_LIMIT:-256M}
        reservations:
          cpus: "${FRONTEND_CPU_RESERVATION:-0.1}"
          memory: ${FRONTEND_MEMORY_RESERVATION:-64M}
    networks:
      - shopbuilder-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Main Spring Boot API server
  spring-api:
    image: ${SPRING_API_IMAGE:-shopbuilder/spring-api:latest}
    container_name: shopbuilder-api
    restart: unless-stopped
    ports:
      - "${SPRING_API_PORT:-8080}:8080"
    environment:
      # JVM configuration with virtual threads support (ZGC for low-latency GC)
      # Heap set to ~75% of container memory to leave room for non-heap memory (metaspace, thread stacks, etc.)
      - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS:--XX:+UseZGC -XX:+ZGenerational -Xmx1536m -Xms512m -XX:+ExitOnOutOfMemoryError -Djava.security.egd=file:/dev/./urandom}
      # Spring configuration
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-production}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:?SPRING_DATASOURCE_URL is required}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:?SPRING_DATASOURCE_USERNAME is required}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:?SPRING_DATASOURCE_PASSWORD is required}
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-shopbuilder}
      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:?AWS_ACCESS_KEY_ID is required}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:?AWS_SECRET_ACCESS_KEY is required}
      - AWS_REGION=${AWS_REGION:-eu-central-1}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:?S3_BUCKET_NAME is required}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      # Stripe Payment Gateway
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:?STRIPE_SECRET_KEY is required}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:?STRIPE_WEBHOOK_SECRET is required}
      # Resend email service
      - RESEND_API_KEY=${RESEND_API_KEY:?RESEND_API_KEY is required}
      - RESEND_WEBHOOK_SECRET=${RESEND_WEBHOOK_SECRET:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-noreply@staticshop.io}
      # Observability: Grafana Cloud OpenTelemetry
      - OTEL_EXPORTER_OTLP_ENDPOINT=${GRAFANA_CLOUD_OTLP_ENDPOINT:-}
      - OTEL_EXPORTER_OTLP_HEADERS=${OTEL_EXPORTER_OTLP_HEADERS:-}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-shopbuilder-api}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES:-deployment.environment=production}
      - OTEL_METRICS_EXPORTER=${OTEL_METRICS_EXPORTER:-otlp}
      - OTEL_TRACES_EXPORTER=${OTEL_TRACES_EXPORTER:-otlp}
      - OTEL_LOGS_EXPORTER=${OTEL_LOGS_EXPORTER:-none}
      # Observability: Sentry error tracking
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-0.1}
      - SERVER_PORT=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "${SPRING_API_CPU_LIMIT:-2.0}"
          memory: ${SPRING_API_MEMORY_LIMIT:-2G}
        reservations:
          cpus: "${SPRING_API_CPU_RESERVATION:-0.5}"
          memory: ${SPRING_API_MEMORY_RESERVATION:-512M}
    networks:
      - shopbuilder-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Background job processing workers
  spring-workers:
    image: ${SPRING_WORKERS_IMAGE:-shopbuilder/spring-workers:latest}
    restart: unless-stopped
    environment:
      # JVM configuration with virtual threads support (ZGC for low-latency GC)
      # Heap set to ~75% of container memory to leave room for non-heap memory (metaspace, thread stacks, etc.)
      - JAVA_TOOL_OPTIONS=${JAVA_TOOL_OPTIONS_WORKERS:--XX:+UseZGC -XX:+ZGenerational -Xmx1536m -Xms512m -XX:+ExitOnOutOfMemoryError -Djava.security.egd=file:/dev/./urandom}
      # Spring configuration
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-production}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:?SPRING_DATASOURCE_URL is required}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:?SPRING_DATASOURCE_USERNAME is required}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:?SPRING_DATASOURCE_PASSWORD is required}
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-shopbuilder}
      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:?AWS_ACCESS_KEY_ID is required}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:?AWS_SECRET_ACCESS_KEY is required}
      - AWS_REGION=${AWS_REGION:-eu-central-1}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:?S3_BUCKET_NAME is required}
      # Resend email service
      - RESEND_API_KEY=${RESEND_API_KEY:?RESEND_API_KEY is required}
      - RESEND_WEBHOOK_SECRET=${RESEND_WEBHOOK_SECRET:-}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-noreply@staticshop.io}
      # Observability: Grafana Cloud OpenTelemetry
      - OTEL_EXPORTER_OTLP_ENDPOINT=${GRAFANA_CLOUD_OTLP_ENDPOINT:-}
      - OTEL_EXPORTER_OTLP_HEADERS=${OTEL_EXPORTER_OTLP_HEADERS:-}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME_WORKERS:-shopbuilder-workers}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES:-deployment.environment=production}
      - OTEL_METRICS_EXPORTER=${OTEL_METRICS_EXPORTER:-otlp}
      - OTEL_TRACES_EXPORTER=${OTEL_TRACES_EXPORTER:-otlp}
      - OTEL_LOGS_EXPORTER=${OTEL_LOGS_EXPORTER:-none}
      # Observability: Sentry error tracking
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-0.1}
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}
      - SERVER_PORT=8081
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "${SPRING_WORKERS_CPU_LIMIT:-2.0}"
          memory: ${SPRING_WORKERS_MEMORY_LIMIT:-2G}
        reservations:
          cpus: "${SPRING_WORKERS_CPU_RESERVATION:-0.5}"
          memory: ${SPRING_WORKERS_MEMORY_RESERVATION:-512M}
    networks:
      - shopbuilder-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - worker-temp:/tmp/worker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # RabbitMQ message broker
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: shopbuilder-rabbitmq
    restart: unless-stopped
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USERNAME:-shopbuilder}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-shopbuilder}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "${RABBITMQ_CPU_LIMIT:-1.0}"
          memory: ${RABBITMQ_MEMORY_LIMIT:-512M}
        reservations:
          cpus: "${RABBITMQ_CPU_RESERVATION:-0.25}"
          memory: ${RABBITMQ_MEMORY_RESERVATION:-256M}
    networks:
      - shopbuilder-network
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  shopbuilder-network:
    driver: bridge
    name: shopbuilder-network

volumes:
  rabbitmq-data:
    name: shopbuilder-rabbitmq-data
  worker-temp:
    name: shopbuilder-worker-temp
