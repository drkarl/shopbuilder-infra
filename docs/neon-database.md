# Neon PostgreSQL Database Configuration

This document describes the Neon PostgreSQL database setup for ShopBuilder infrastructure.

## Overview

Neon is a serverless PostgreSQL platform that provides:
- Autoscaling compute
- Automatic point-in-time recovery (PITR) backups
- Built-in connection pooling via PgBouncer
- Branch-based development workflows

## Connection Types

Neon provides two connection endpoints for each project:

### Pooled Connection (for application)
- Hostname pattern: `ep-xxx-xxx-pooler.<region>.aws.neon.tech`
- Uses PgBouncer in transaction mode
- Recommended for serverless and high-concurrency applications
- Environment variable: `DATABASE_URL`

### Direct Connection (for migrations)
- Hostname pattern: `ep-xxx-xxx.<region>.aws.neon.tech`
- Direct PostgreSQL connection
- Required for Flyway migrations and schema changes
- Environment variable: `DATABASE_URL_DIRECT`

## Connection String Format

```
postgresql://[user]:[password]@[endpoint].neon.tech/[database]?sslmode=require
```

SSL/TLS is always required for Neon connections.

## Spring Boot Configuration

Configure your Spring Boot application to use both connection types:

```yaml
spring:
  datasource:
    url: ${DATABASE_URL}
    hikari:
      maximum-pool-size: 10
      connection-timeout: 30000
  flyway:
    # URL contains embedded credentials, no separate user/password needed
    url: ${DATABASE_URL_DIRECT}
```

## Environment Configurations

### Production
- **Compute**: 0.5 - 2 CU (autoscaling)
- **Suspend timeout**: Disabled (always on)
- **PITR retention**: 7 days
- **Region**: aws-eu-central-1

### Staging
- **Compute**: 0.25 - 1 CU (autoscaling)
- **Suspend timeout**: 300 seconds (5 minutes)
- **PITR retention**: 1 day
- **Region**: aws-eu-central-1

## Terraform Outputs

After applying Terraform, retrieve connection information:

```bash
# Get all non-sensitive outputs
terraform output neon_connection_info

# Get sensitive connection URIs
terraform output -raw neon_connection_uri_pooler
terraform output -raw neon_connection_uri
```

## Backup and Restore

Neon handles backups automatically with point-in-time recovery:

1. **Automatic backups**: Continuous WAL archiving
2. **Retention**: Configured per environment (staging: 1 day, prod: 7 days)
3. **Restore**: Use Neon Console or API to restore to any point in the retention window

### Restoring from PITR

Via Neon Console:
1. Navigate to your project
2. Go to "Branches" tab
3. Click "Create branch"
4. Select "Point in time" and choose your restore timestamp

Via Terraform (create a new branch from a point in time):
```hcl
resource "neon_branch" "restore" {
  project_id = neon_project.this.id
  parent_id  = neon_project.this.default_branch_id
  name       = "restore-2025-12-13"
  parent_timestamp = "2025-12-13T10:30:00Z"
}
```

## Security

### SSL/TLS
All connections require SSL (`sslmode=require`). Neon uses TLS 1.3.

### IP Allow Lists
Configure allowed IPs via Terraform:
```hcl
neon_allowed_ips = ["10.0.0.0/8", "192.168.1.0/24"]
```

### Credentials
- Credentials are generated by Neon and output from Terraform
- Store credentials securely in SOPS-encrypted secrets files
- Rotate credentials by recreating the Neon role

## Terraform Variables

Required variables for each environment:

| Variable | Description | Example |
|----------|-------------|---------|
| `neon_org_id` | Neon organization ID | `org-xxx-xxx` |
| `neon_region_id` | AWS region for Neon | `aws-eu-central-1` |

Optional variables with defaults:

| Variable | Description | Default (Prod) | Default (Staging) |
|----------|-------------|----------------|-------------------|
| `neon_database_name` | Database name | `shopbuilder` | `shopbuilder` |
| `neon_database_role` | Database role | `shopbuilder` | `shopbuilder` |
| `neon_pg_version` | PostgreSQL version | `16` | `16` |
| `neon_autoscaling_min_cu` | Min compute units | `0.5` | `0.25` |
| `neon_autoscaling_max_cu` | Max compute units | `2` | `1` |
| `neon_suspend_timeout_seconds` | Idle timeout | `0` (disabled) | `300` |
| `neon_history_retention_seconds` | PITR retention | `604800` (7 days) | `86400` (1 day) |

## Initial Setup

1. Create a Neon API key at https://console.neon.tech/app/settings/api-keys

2. Find your Organization ID at https://console.neon.tech/app/settings/organization

3. Set environment variables:
   ```bash
   export NEON_API_KEY="your-api-key"  # pragma: allowlist secret
   ```

4. Create terraform.tfvars for your environment:
   ```hcl
   neon_org_id = "org-xxx-xxx"
   ```

5. Run Terraform:
   ```bash
   cd terraform/environments/prod
   terraform init
   terraform plan
   terraform apply
   ```

6. Retrieve and store connection strings:
   ```bash
   # Get pooled connection (for application)
   terraform output -raw neon_connection_uri_pooler

   # Get direct connection (for Flyway)
   terraform output -raw neon_connection_uri
   ```

## Troubleshooting

### Connection timeouts
- Ensure compute is not suspended (staging only)
- Check IP allow lists if configured
- Verify SSL is enabled in connection string

### Flyway migration failures
- Ensure using direct connection (not pooler)
- Check database role has necessary permissions
- Verify schema exists

### Pooler connection issues
- Use transaction mode compatible queries
- Avoid session-level settings
- Don't use LISTEN/NOTIFY through pooler
